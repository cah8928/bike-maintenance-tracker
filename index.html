<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VeloTrack: Bike Maintenance Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2d3748; /* gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568; /* gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #718096; /* gray-500 */
        }
        .modal {
            display: none;
        }
        .modal.is-open {
            display: flex;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans antialiased">

    <!-- App Container -->
    <div id="app-container" class="container mx-auto p-4 md:p-6 lg:p-8">

        <!-- Header -->
        <header class="flex flex-col sm:flex-row justify-between items-center mb-8 pb-4 border-b border-gray-700">
            <h1 class="text-3xl md:text-4xl font-bold text-white mb-4 sm:mb-0">
                Velo<span class="text-cyan-400">Track</span>
            </h1>
            <button id="add-bike-btn" class="w-full sm:w-auto bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                + Add New Bike
            </button>
        </header>

        <!-- Weather Section -->
        <section id="weather-section" class="mb-8 p-6 bg-gray-800 rounded-lg shadow-xl">
            <h2 class="text-2xl font-semibold mb-4 text-white">Best & Worst Days to Ride</h2>
            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                <input type="text" id="city-input" placeholder="Enter City Name" class="flex-grow bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-500">
                <div class="flex gap-4">
                     <button id="get-weather-btn" class="w-full sm:w-auto bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition">Get Forecast</button>
                    <button id="use-location-btn" class="w-full sm:w-auto bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition">Use My Location</button>
                </div>
            </div>
            <div id="weather-forecast" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-7 gap-4 text-center">
                <!-- Weather data will be injected here -->
                <p class="col-span-full text-gray-400">Enter a city or use your location to get a 7-day ride forecast.</p>
            </div>
        </section>


        <!-- Main Content: Bike List -->
        <main id="bike-list" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Bike cards will be injected here -->
        </main>

        <div id="no-bikes-message" class="text-center py-16 px-6 bg-gray-800 rounded-lg shadow-lg">
            <h2 class="text-2xl font-semibold mb-2">Welcome to VeloTrack!</h2>
            <p class="text-gray-400">You haven't added any bikes yet. Click "Add New Bike" to get started.</p>
        </div>

    </div>

    <!-- MODALS -->

    <!-- Add/Edit Bike Modal -->
    <div id="bike-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg shadow-2xl p-8 w-11/12 md:w-1/3">
            <h2 id="bike-modal-title" class="text-2xl font-bold mb-6">Add a New Bike</h2>
            <form id="bike-form">
                <input type="hidden" id="bike-id-input">
                <div>
                    <label for="bike-name-input" class="block text-sm font-medium text-gray-300 mb-1">Bike Name</label>
                    <input type="text" id="bike-name-input" placeholder="e.g., Canyon Aeroad" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-500" required>
                </div>
                <div class="mt-8 flex justify-end gap-4">
                    <button type="button" class="modal-close-btn bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition">Cancel</button>
                    <button type="submit" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg transition">Save Bike</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Component Modal -->
    <div id="component-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg shadow-2xl p-8 w-11/12 md:w-1/3">
            <h2 class="text-2xl font-bold mb-6">Add a New Component</h2>
            <form id="component-form">
                <input type="hidden" id="component-bike-id">
                 <div class="mb-4">
                    <label for="component-type-select" class="block text-sm font-medium text-gray-300 mb-1">Component</label>
                    <select id="component-type-select" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-500"></select>
                </div>
                 <div id="chain-type-container" class="mb-4 hidden">
                    <label for="chain-type-select" class="block text-sm font-medium text-gray-300 mb-1">Chain Type</label>
                    <select id="chain-type-select" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-500">
                        <option value="Lubed">Lubed</option>
                        <option value="Waxed">Waxed</option>
                    </select>
                </div>
                <div id="lifespan-container" class="mb-4">
                    <label for="component-lifespan-input" class="block text-sm font-medium text-gray-300 mb-1">Service Interval / Lifespan (in miles)</label>
                    <input type="number" id="component-lifespan-input" placeholder="e.g., 2000" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-500" required>
                </div>
                <div class="mt-8 flex justify-end gap-4">
                    <button type="button" class="modal-close-btn bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition">Cancel</button>
                    <button type="submit" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg transition">Add Component</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Log Ride Modal -->
    <div id="ride-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg shadow-2xl p-8 w-11/12 md:w-1/3">
            <h2 class="text-2xl font-bold mb-6">Log a New Ride</h2>
            <form id="ride-form">
                <input type="hidden" id="ride-bike-id">
                <div class="mb-4">
                    <label for="ride-distance-input" class="block text-sm font-medium text-gray-300 mb-1">Distance (miles)</label>
                    <input type="number" step="0.1" id="ride-distance-input" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-500" required>
                </div>
                 <div class="mb-4">
                    <label for="ride-date-input" class="block text-sm font-medium text-gray-300 mb-1">Date</label>
                    <input type="date" id="ride-date-input" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-500" required>
                </div>
                <div class="mb-4">
                    <label for="ride-conditions-select" class="block text-sm font-medium text-gray-300 mb-1">Ride Conditions</label>
                    <select id="ride-conditions-select" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-500">
                        <option value="Dry">Dry</option>
                        <option value="Damp/Mixed">Damp/Mixed</option>
                        <option value="Wet">Wet</option>
                    </select>
                </div>
                <div class="mt-8 flex justify-end gap-4">
                    <button type="button" class="modal-close-btn bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition">Cancel</button>
                    <button type="submit" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg transition">Log Ride</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Component Details Modal -->
    <div id="component-details-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg shadow-2xl p-8 w-11/12 md:w-2/3 lg:w-1/2">
            <h2 id="component-details-title" class="text-2xl font-bold mb-6">Component Details</h2>
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-300 mb-2">Current Interval Wear</h3>
                <div class="bg-gray-700 p-4 rounded-lg">
                    <canvas id="wear-chart"></canvas>
                </div>
            </div>
            <div>
                 <h3 class="text-lg font-semibold text-gray-300 mb-2">Service History</h3>
                 <div id="service-history-log" class="max-h-48 overflow-y-auto bg-gray-900 p-4 rounded-lg">
                    <!-- History logs go here -->
                 </div>
            </div>
            <div class="mt-8 flex justify-end">
                <button type="button" class="modal-close-btn bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition">Close</button>
            </div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div id="notification-modal" class="modal fixed inset-0 bg-black bg-opacity-70 items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg shadow-2xl p-8 w-11/12 md:w-1/3">
            <h2 id="notification-title" class="text-2xl font-bold mb-4 text-yellow-400">Maintenance Alert</h2>
            <div id="notification-content" class="text-gray-300 space-y-2">
                <!-- Notification messages go here -->
            </div>
            <div class="mt-8 flex justify-end">
                <button type="button" class="modal-close-btn bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg transition">Got it</button>
            </div>
        </div>
    </div>

      <!-- (Your body HTML ends here) -->
    
    <script>
    // WRAP EVERYTHING in this DOMContentLoaded listener
    document.addEventListener('DOMContentLoaded', function() {

        // --- APPLICATION STATE & CONFIG --- //

        let state = {
            bikes: []
        };
        
        const wearMultipliers = {
            'Dry': 1,
            'Damp/Mixed': 1.5,
            'Wet': 2
        };

        const initialComponents = [
            { name: "Chain", type: "drivetrain", defaultLifespan: 2000, hasSubtype: true },
            { name: "Cassette", type: "drivetrain", defaultLifespan: 4000 },
            { name: "Chainrings", type: "drivetrain", defaultLifespan: 8000 },
            { name: "Brake Pads (Front)", type: "brakes", defaultLifespan: 3000 },
            { name: "Brake Pads (Rear)", type: "brakes", defaultLifespan: 3000 },
            { name: "Brake Cable/Fluid Service", type: "brakes", defaultLifespan: 5000 },
            { name: "Tire (Front)", type: "wheels", defaultLifespan: 2500 },
            { name: "Tire (Rear)", type: "wheels", defaultLifespan: 2500 },
            { name: "Shoe Cleats", type: "contact", defaultLifespan: 3000 },
            { name: "Full Bike Wash", type: "general", defaultLifespan: 200 },
            { name: "Power Meter Battery", type: "electronics", isBattery: true },
            { name: "Shifting Battery", type: "electronics", isBattery: true },
        ];

        let wearChart = null;

        // --- DOM ELEMENTS --- //

        const bikeList = document.getElementById('bike-list');
        const noBikesMessage = document.getElementById('no-bikes-message');
        
        // Modals
        const bikeModal = document.getElementById('bike-modal');
        const componentModal = document.getElementById('component-modal');
        const rideModal = document.getElementById('ride-modal');
        const componentDetailsModal = document.getElementById('component-details-modal');
        const notificationModal = document.getElementById('notification-modal');
        
        // Forms & Inputs
        const bikeForm = document.getElementById('bike-form');
        const bikeIdInput = document.getElementById('bike-id-input');
        const bikeNameInput = document.getElementById('bike-name-input');
        const bikeModalTitle = document.getElementById('bike-modal-title');

        const componentForm = document.getElementById('component-form');
        const componentBikeIdInput = document.getElementById('component-bike-id');
        const componentTypeSelect = document.getElementById('component-type-select');
        const chainTypeContainer = document.getElementById('chain-type-container');
        const chainTypeSelect = document.getElementById('chain-type-select');
        const componentLifespanInput = document.getElementById('component-lifespan-input');
        const lifespanContainer = document.getElementById('lifespan-container');
        
        const rideForm = document.getElementById('ride-form');
        const rideBikeIdInput = document.getElementById('ride-bike-id');
        const rideDistanceInput = document.getElementById('ride-distance-input');
        const rideDateInput = document.getElementById('ride-date-input');
        const rideConditionsSelect = document.getElementById('ride-conditions-select');
        
        // --- DATA PERSISTENCE --- //
        
        const saveState = () => {
            try {
                localStorage.setItem('veloTrackState', JSON.stringify(state));
            } catch (e) {
                console.error("Error saving state to localStorage", e);
            }
        };

        const loadState = () => {
            try {
                const savedState = localStorage.getItem('veloTrackState');
                if (savedState) {
                    state = JSON.parse(savedState);
                    // Ensure nested objects that might have been added later exist
                    state.bikes.forEach(bike => {
                        if (!bike.cleaning) {
                           bike.cleaning = { frame: false, drivetrain: false, wheels: false, brakes: false, cockpit: false };
                        }
                    });
                }
            } catch (e) {
                console.error("Error loading state from localStorage", e);
                state = { bikes: [] }; // Reset to a safe default
            }
        };

        // --- UTILITY FUNCTIONS --- //

        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
        
        const openModal = (modal) => modal.classList.add('is-open');
        const closeModal = (modal) => modal.classList.remove('is-open');
        
        const formatDate = (dateString) => new Date(dateString).toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });

        // --- RENDER FUNCTIONS --- //
        
        const render = () => {
            bikeList.innerHTML = '';
            if (state.bikes.length === 0) {
                noBikesMessage.style.display = 'block';
                bikeList.style.display = 'none';
            } else {
                noBikesMessage.style.display = 'none';
                bikeList.style.display = 'grid';
                state.bikes.forEach(bike => {
                    const bikeCard = createBikeCard(bike);
                    bikeList.appendChild(bikeCard);
                });
            }
        };
        
        const createBikeCard = (bike) => {
            const card = document.createElement('div');
            card.className = 'bg-gray-800 rounded-lg shadow-xl p-6 flex flex-col gap-4';
            card.dataset.bikeId = bike.id;

            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <h2 class="text-2xl font-bold text-white">${bike.name}</h2>
                        <button class="edit-bike-btn text-sm text-cyan-400 hover:text-cyan-300" data-bike-id="${bike.id}">Edit Name</button>
                    </div>
                    <div class="flex gap-2">
                        <button class="log-ride-btn bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-3 rounded-lg text-sm" data-bike-id="${bike.id}">Log Ride</button>
                        <button class="delete-bike-btn bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-lg text-sm" data-bike-id="${bike.id}">Delete</button>
                    </div>
                </div>

                <div>
                    <h3 class="text-lg font-semibold border-b border-gray-700 pb-2 mb-3">Components</h3>
                    <div class="component-list space-y-3">
                        <!-- Components will be rendered here -->
                    </div>
                    <button class="add-component-btn mt-4 text-cyan-400 hover:text-cyan-300 w-full text-left font-semibold text-sm" data-bike-id="${bike.id}">+ Add Component</button>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold border-b border-gray-700 pb-2 mb-3">Cleaning Status</h3>
                    <div class="cleaning-checklist grid grid-cols-2 gap-2 text-sm">
                        ${['Frame', 'Drivetrain', 'Wheels', 'Brakes', 'Cockpit'].map(item => `
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" class="cleaning-checkbox form-checkbox bg-gray-700 border-gray-600 rounded text-cyan-500 focus:ring-cyan-500" data-item="${item.toLowerCase()}" ${bike.cleaning[item.toLowerCase()] ? 'checked' : ''}>
                                <span>${item}</span>
                            </label>
                        `).join('')}
                    </div>
                    <button class="reset-cleaning-btn mt-3 text-gray-400 hover:text-white text-xs w-full text-left" data-bike-id="${bike.id}">Reset All</button>
                </div>
            `;

            const componentListContainer = card.querySelector('.component-list');
            if (bike.components && bike.components.length > 0) {
                bike.components.forEach(component => {
                    componentListContainer.appendChild(createComponentItem(component, bike.id));
                });
            } else {
                componentListContainer.innerHTML = `<p class="text-sm text-gray-400">No components added yet.</p>`;
            }
            
            return card;
        };

        const createComponentItem = (component, bikeId) => {
            const item = document.createElement('div');
            item.className = 'component-item';
            
            let display;
            if (component.isBattery) {
                const daysSince = component.lastServiceDate ? Math.floor((new Date() - new Date(component.lastServiceDate)) / (1000 * 60 * 60 * 24)) : 'N/A';
                display = `
                    <div class="flex justify-between items-center text-sm">
                        <span class="font-semibold text-gray-300">${component.name}</span>
                        <span class="text-gray-400">Charged ${daysSince} days ago</span>
                    </div>
                `;
            } else {
                const wearPercentage = Math.min(100, (component.wear / component.lifespan) * 100);
                let progressBarColor = 'bg-green-500';
                if (wearPercentage > 80) progressBarColor = 'bg-red-500';
                else if (wearPercentage > 60) progressBarColor = 'bg-yellow-500';

                display = `
                    <div class="flex justify-between items-center text-xs mb-1">
                        <span class="font-semibold text-gray-300 component-details-btn cursor-pointer hover:text-cyan-400" data-component-id="${component.id}" data-bike-id="${bikeId}">${component.name}</span>
                        <span class="text-gray-400">${Math.round(component.wear)} / ${component.lifespan} mi</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2.5">
                        <div class="${progressBarColor} h-2.5 rounded-full" style="width: ${wearPercentage}%"></div>
                    </div>
                `;
            }

            item.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="flex-grow">${display}</div>
                    <button class="service-reset-btn bg-gray-600 hover:bg-gray-500 text-white font-bold py-1 px-2 rounded-md text-xs" data-component-id="${component.id}" data-bike-id="${bikeId}">
                        ${component.isBattery ? 'Charged' : 'Service'}
                    </button>
                </div>
            `;
            return item;
        };

        // --- EVENT HANDLERS --- //

        const handleAddBikeClick = () => {
            bikeForm.reset();
            bikeIdInput.value = '';
            bikeModalTitle.textContent = 'Add a New Bike';
            openModal(bikeModal);
        };

        const handleBikeFormSubmit = (e) => {
            e.preventDefault();
            const bikeId = bikeIdInput.value;
            const bikeName = bikeNameInput.value.trim();
            if (!bikeName) return;

            if (bikeId) { // Editing existing bike
                const bike = state.bikes.find(b => b.id === bikeId);
                if (bike) bike.name = bikeName;
            } else { // Adding new bike
                const newBike = {
                    id: generateId(),
                    name: bikeName,
                    components: [],
                    rides: [],
                    cleaning: { frame: false, drivetrain: false, wheels: false, brakes: false, cockpit: false }
                };
                state.bikes.push(newBike);
            }
            
            saveState();
            render();
            closeModal(bikeModal);
        };
        
        const handleBikeListClick = (e) => {
            const target = e.target;
            const bikeId = target.closest('[data-bike-id]')?.dataset.bikeId;
            if (!bikeId) return;

            if (target.classList.contains('edit-bike-btn')) {
                const bike = state.bikes.find(b => b.id === bikeId);
                if (bike) {
                    bikeModalTitle.textContent = 'Edit Bike Name';
                    bikeIdInput.value = bike.id;
                    bikeNameInput.value = bike.name;
                    openModal(bikeModal);
                }
            } else if (target.classList.contains('delete-bike-btn')) {
                if (confirm('Are you sure you want to delete this bike and all its data?')) {
                    state.bikes = state.bikes.filter(b => b.id !== bikeId);
                    saveState();
                    render();
                }
            } else if (target.classList.contains('add-component-btn')) {
                componentBikeIdInput.value = bikeId;
                componentForm.reset();
                populateComponentSelect(bikeId);
                handleComponentTypeChange();
                openModal(componentModal);
            } else if (target.classList.contains('log-ride-btn')) {
                rideBikeIdInput.value = bikeId;
                rideForm.reset();
                rideDateInput.value = new Date().toISOString().split('T')[0]; // Set today's date
                openModal(rideModal);
            } else if (target.classList.contains('service-reset-btn')) {
                const componentId = target.dataset.componentId;
                serviceComponent(bikeId, componentId);
            } else if (target.classList.contains('component-details-btn')) {
                const componentId = target.dataset.componentId;
                showComponentDetails(bikeId, componentId);
            } else if (target.classList.contains('reset-cleaning-btn')) {
                const bike = state.bikes.find(b => b.id === bikeId);
                if (bike) {
                    Object.keys(bike.cleaning).forEach(key => bike.cleaning[key] = false);
                    saveState();
                    render();
                }
            } else if (target.classList.contains('cleaning-checkbox')) {
                const bike = state.bikes.find(b => b.id === bikeId);
                const item = target.dataset.item;
                if (bike) {
                    bike.cleaning[item] = target.checked;
                    saveState();
                    // No need to re-render for a checkbox change
                }
            }
        };
        
        const populateComponentSelect = (bikeId) => {
            const bike = state.bikes.find(b => b.id === bikeId);
            const existingComponentNames = bike.components.map(c => c.baseName);
            const availableComponents = initialComponents.filter(ic => !existingComponentNames.includes(ic.name));

            componentTypeSelect.innerHTML = availableComponents
                .map(c => `<option value="${c.name}">${c.name}</option>`)
                .join('');
        };
        
        const handleComponentTypeChange = () => {
            const selectedName = componentTypeSelect.value;
            const componentInfo = initialComponents.find(c => c.name === selectedName);
            if (!componentInfo) return;

            chainTypeContainer.classList.toggle('hidden', !componentInfo.hasSubtype);
            lifespanContainer.classList.toggle('hidden', !!componentInfo.isBattery);
            
            if (componentInfo.defaultLifespan) {
                componentLifespanInput.value = componentInfo.defaultLifespan;
            }
        };

        const handleComponentFormSubmit = (e) => {
            e.preventDefault();
            const bikeId = componentBikeIdInput.value;
            const baseName = componentTypeSelect.value;
            const componentInfo = initialComponents.find(c => c.name === baseName);
            if (!bikeId || !baseName || !componentInfo) return;

            let finalName = baseName;
            if (componentInfo.hasSubtype) {
                finalName = `${baseName} (${chainTypeSelect.value})`;
            }

            const newComponent = {
                id: generateId(),
                name: finalName,
                baseName: baseName,
                wear: 0,
                isBattery: componentInfo.isBattery || false,
                lifespan: componentInfo.isBattery ? null : parseInt(componentLifespanInput.value, 10),
                lastServiceDate: new Date().toISOString(),
                history: [{ date: new Date().toISOString(), notes: 'Component Added' }]
            };
            
            const bike = state.bikes.find(b => b.id === bikeId);
            bike.components.push(newComponent);
            saveState();
            render();
            closeModal(componentModal);
        };

        const handleRideFormSubmit = (e) => {
            e.preventDefault();
            const bikeId = rideBikeIdInput.value;
            const distance = parseFloat(rideDistanceInput.value);
            const date = rideDateInput.value;
            const conditions = rideConditionsSelect.value;
            
            if (isNaN(distance) || distance <= 0) return;

            const bike = state.bikes.find(b => b.id === bikeId);
            if (!bike) return;

            const multiplier = wearMultipliers[conditions];
            const effectiveWear = distance * multiplier;

            const notifications = [];

            bike.components.forEach(component => {
                if (!component.isBattery) {
                    component.wear += effectiveWear;
                    const wearPercentage = (component.wear / component.lifespan) * 100;
                    if (wearPercentage >= 100) {
                        notifications.push({ type: 'required', name: component.name });
                    } else if (wearPercentage > 80) {
                        notifications.push({ type: 'soon', name: component.name });
                    }
                }
            });
            
            if (!bike.rides) { bike.rides = []; }
            bike.rides.push({ date, distance, conditions });

            saveState();
            render();
            closeModal(rideModal);
            
            if (notifications.length > 0) {
                showNotifications(notifications);
            }
        };
        
        const serviceComponent = (bikeId, componentId) => {
            const bike = state.bikes.find(b => b.id === bikeId);
            const component = bike.components.find(c => c.id === componentId);

            const totalMileage = bike.rides ? bike.rides.reduce((acc, ride) => acc + ride.distance, 0) : 0;
            
            component.lastServiceDate = new Date().toISOString();
            if (!component.history) { component.history = []; }
            component.history.push({ date: new Date().toISOString(), mileageAtService: totalMileage, notes: 'Serviced' });
            
            if (!component.isBattery) {
                component.wear = 0;
            }
            
            saveState();
            render();
        };

        const showComponentDetails = (bikeId, componentId) => {
            const bike = state.bikes.find(b => b.id === bikeId);
            const component = bike.components.find(c => c.id === componentId);
            
            document.getElementById('component-details-title').textContent = `${component.name} Details`;
            
            // Render service history
            const historyLog = document.getElementById('service-history-log');
            if (component.history && component.history.length > 0) {
                historyLog.innerHTML = component.history.slice().reverse().map(entry => 
                    `<div class="p-2 border-b border-gray-700 text-sm">
                        <p>Event: <span class="font-semibold">${entry.notes || 'Service'} on ${formatDate(entry.date)}</span></p>
                    </div>`
                ).join('');
            } else {
                historyLog.innerHTML = `<p class="text-sm text-gray-400">No service history yet.</p>`;
            }
            
            // Chart rendering logic for non-battery components
            const canvas = document.getElementById('wear-chart');
            if (component.isBattery) {
                canvas.style.display = 'none'; // Hide chart for batteries
            } else {
                canvas.style.display = 'block'; // Show chart for others
                const ridesSinceLastService = (bike.rides || []).filter(ride => new Date(ride.date) >= new Date(component.lastServiceDate));
                ridesSinceLastService.sort((a, b) => new Date(a.date) - new Date(b.date));

                const labels = [];
                const data = [];
                let cumulativeWear = 0;

                ridesSinceLastService.forEach(ride => {
                    const multiplier = wearMultipliers[ride.conditions];
                    cumulativeWear += ride.distance * multiplier;
                    labels.push(formatDate(ride.date));
                    data.push(cumulativeWear);
                });

                const ctx = canvas.getContext('2d');
                if (wearChart) {
                    wearChart.destroy();
                }
                wearChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Cumulative Wear (miles)',
                            data: data,
                            borderColor: 'rgb(34, 211, 238)',
                            backgroundColor: 'rgba(34, 211, 238, 0.2)',
                            tension: 0.1,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: { y: { beginAtZero: true, grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#d1d5db' } }, x: { grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#d1d5db' } } },
                        plugins: { legend: { labels: { color: '#d1d5db' } } }
                    }
                });
            }
            openModal(componentDetailsModal);
        };
        
        const showNotifications = (notifications) => {
            const content = document.getElementById('notification-content');
            
            const required = notifications.filter(n => n.type === 'required');
            const soon = notifications.filter(n => n.type === 'soon');
            
            let html = '';
            
            if(required.length > 0) {
                html += `<h3 class="font-bold text-red-500">Service Required:</h3><ul class="list-disc list-inside">${required.map(n => `<li>${n.name}</li>`).join('')}</ul>`;
            }
            if(soon.length > 0) {
                html += `<h3 class="font-bold text-yellow-400 mt-2">Maintenance Due Soon:</h3><ul class="list-disc list-inside">${soon.map(n => `<li>${n.name}</li>`).join('')}</ul>`;
            }
            
            content.innerHTML = html;
            openModal(notificationModal);
        };

        // --- WEATHER FEATURE --- //
        
        const handleGetWeather = async (useGeolocation = false) => {
            const forecastContainer = document.getElementById('weather-forecast');
            forecastContainer.innerHTML = `<p class="col-span-full text-gray-400">Fetching forecast...</p>`;

            try {
                let lat, lon;
                if (useGeolocation) {
                    const position = await new Promise((resolve, reject) => {
                        if (!navigator.geolocation) {
                           reject(new Error("Geolocation is not supported by your browser."));
                        }
                        navigator.geolocation.getCurrentPosition(resolve, reject);
                    });
                    lat = position.coords.latitude;
                    lon = position.coords.longitude;
                } else {
                    const city = document.getElementById('city-input').value.trim();
                    if (!city) {
                        forecastContainer.innerHTML = `<p class="col-span-full text-red-400">Please enter a city name.</p>`;
                        return;
                    }
                    const geoResponse = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&language=en&format=json`);
                    const geoData = await geoResponse.json();
                    if (!geoData.results || geoData.results.length === 0) {
                        throw new Error('City not found.');
                    }
                    lat = geoData.results[0].latitude;
                    lon = geoData.results[0].longitude;
                }
                
                const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=weathercode,temperature_2m_max,apparent_temperature_max,precipitation_probability_max,windspeed_10m_max&temperature_unit=fahrenheit&windspeed_unit=mph&timezone=auto`;
                const weatherResponse = await fetch(weatherUrl);
                const weatherData = await weatherResponse.json();
                
                renderWeather(weatherData);

            } catch (error) {
                console.error("Weather fetch error:", error);
                forecastContainer.innerHTML = `<p class="col-span-full text-red-400">Error: ${error.message}. Please try again.</p>`;
            }
        };

        const renderWeather = (data) => {
            const forecastContainer = document.getElementById('weather-forecast');
            forecastContainer.innerHTML = '';
            
            data.daily.time.forEach((day, index) => {
                const dayOfWeek = new Date(day + 'T00:00:00').toLocaleDateString(undefined, { weekday: 'short' });
                const precip = data.daily.precipitation_probability_max[index];
                const temp = data.daily.apparent_temperature_max[index];
                const wind = data.daily.windspeed_10m_max[index];

                let rating = 'neutral';
                let ratingClass = 'bg-gray-700';
                
                if (precip < 25 && temp >= 50 && temp <= 85 && wind < 15) {
                    rating = 'Best';
                    ratingClass = 'bg-green-600';
                }
                else if (precip > 60 || temp < 40 || temp > 95 || wind > 25) {
                    rating = 'Worst';
                    ratingClass = 'bg-red-600';
                }

                const dayCard = document.createElement('div');
                dayCard.className = `p-3 rounded-lg flex flex-col items-center justify-between ${ratingClass} transition-transform transform hover:scale-105`;
                dayCard.innerHTML = `
                    <div class="font-bold text-lg">${dayOfWeek}</div>
                    <div class="text-2xl font-light my-1">${Math.round(data.daily.temperature_2m_max[index])}°F</div>
                    <div class="text-xs text-gray-300">💧 ${precip}%</div>
                    <div class="text-xs text-gray-300">💨 ${Math.round(wind)} mph</div>
                    ${rating !== 'neutral' ? `<div class="mt-2 text-xs font-bold px-2 py-0.5 rounded-full ${rating === 'Best' ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800'}">${rating}</div>` : ''}
                `;
                forecastContainer.appendChild(dayCard);
            });
        };
        
        // --- INITIALIZATION --- //

        const init = () => {
            loadState();
            
            // Set up event listeners
            document.getElementById('add-bike-btn').addEventListener('click', handleAddBikeClick);
            bikeForm.addEventListener('submit', handleBikeFormSubmit);
            bikeList.addEventListener('click', handleBikeListClick);
            componentTypeSelect.addEventListener('change', handleComponentTypeChange);
            componentForm.addEventListener('submit', handleComponentFormSubmit);
            rideForm.addEventListener('submit', handleRideFormSubmit);
            
            document.querySelectorAll('.modal-close-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    closeModal(btn.closest('.modal'));
                });
            });

            // Weather listeners
            document.getElementById('get-weather-btn').addEventListener('click', () => handleGetWeather(false));
            document.getElementById('use-location-btn').addEventListener('click', () => handleGetWeather(true));

            render();
            // Try fetching weather on load if possible
            handleGetWeather(true).catch(err => console.log("Could not auto-fetch weather on load. User interaction required."));
        };

        init();
    }); // <-- The closing brackets for the DOMContentLoaded listener
    </script> 

</body>
</html>